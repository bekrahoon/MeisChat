{% extends "main.html" %}
{% block content %}
<div class="group-container" style="background-color: #2f2f2f; padding: 20px;">

  <div class="group-header" style="margin-bottom: 20px;">
    <!--Группы-->
    {% include "base/feed_component.html" %}
    <!--КОНЕЦ Группы-->
  </div>
    
  <div class="chat-layout" style="padding: 20px;">
    <div class="chat-header" style="background-color: #1a1a1a; color: #fff; padding: 10px;">
      <div>
        <!-- Статус пользователя -->
        <span id="user-status-{{ user.id }}">{{ user_status }}</span>
        {{ user.username }}
      </div>
    
      <h3>{{ group.name }}</h3>
      <p>{{ group.description }}</p>
    </div>

    <!-- Прокручиваемая область с сообщениями -->
    <div id="chat-messages" class="chat-messages" style="background-color: #3b3b3b; padding: 20px;">
      <div id="chat_room" style="padding: 20px;">
        {% for message in group_messages %} 
        {% include "base/chat_message.html" %} 
        {% endfor %}
      </div>
    </div>

    <!-- Форма для отправки сообщений -->
    <div class="room__message" style="background-color: #2f2f2f; padding: 20px;">
      <form id="message-form" action="" method="POST" enctype="multipart/form-data" style="margin-top: 20px; display: flex; flex-direction: row; align-items: center;">
        {% csrf_token %}
        <div style="display: flex; flex-direction: column; justify-content: space-between; margin-right: 10px;">
          <div style="display: flex; flex-direction: row;">
            <button type="button" id="upload-image-button" style="background-color: #1a1a1a; color: #fff; padding: 10px; border-radius: 10px;">Image</button>
            <button type="button" id="upload-video-button" style="background-color: #1a1a1a; color: #fff; padding: 10px; border-radius: 10px; margin-left: 10px;">Video</button>
            <button type="button" id="upload-file-button" style="background-color: #1a1a1a; color: #fff; padding: 10px; border-radius: 10px; margin-left: 10px;">File</button>
          </div>
          <input type="file" id="image-input" name="image" accept="image/*" style="display: none;" />
          <input type="file" id="video-input" name="video" accept="video/*" style="display: none;" />
          <input type="file" id="file-input" name="file" accept="*/*" style="display: none;" />
        </div>
        <textarea id="message-input" name="body" placeholder="Write your message here..." style="background-color: #4f4f4f; color: #fff; padding: 10px; width: 60%; height: 60px; border-radius: 10px;"></textarea>
        <button type="button" id="send-button" style="background-color: #1a1a1a; color: #fff; padding: 10px; border-radius: 10px; margin-left: 10px;">Send</button>
      </form>
    </div>
    
  </div>
</div>

<style>
  .group-container {
    display: grid;
    grid-template-columns: 1fr 3fr;
    height: 80vh; /* Занимает всю высоту экрана */
    padding: 20px;
  }

  .chat-layout {
    display: grid;
    grid-template-rows: auto 1fr auto; /* Автоматическая высота для заголовка, растяжение для сообщений и фиксированная высота для формы */
    height: 100%; /* Занимает всю оставшуюся высоту */
    padding: 20px;
  }
  .group-header {
    height: 100%;
    overflow-y: auto; /* Прокрутка для сообщений */
    padding: 20px;
  }

  .chat-messages {
    height: 300px;
    overflow-y: auto; /* Прокрутка для сообщений */
    padding: 20px;
  }

  .form-container {
    display: flex;
    justify-content: center; /* Центрирование формы */
    padding: 20px;
  }
  .room__message {
    padding: 20px;
  }
</style>

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadImageButton = document.getElementById('upload-image-button');
  const uploadVideoButton = document.getElementById('upload-video-button');
  const uploadFileButton = document.getElementById('upload-file-button');
  const imageInput = document.getElementById('image-input');
  const videoInput = document.getElementById('video-input');
  const fileInput = document.getElementById('file-input');
  const sendButton = document.getElementById('send-button');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const userStatusElement = document.getElementById('user-status-{{ user.id }}');

  // Открытие диалогового окна выбора изображений
  uploadImageButton.addEventListener('click', function() {
    imageInput.click();
  });

  // Открытие диалогового окна выбора видео
  uploadVideoButton.addEventListener('click', function() {
    videoInput.click();
  });

  // Открытие диалогового окна выбора других файлов
  uploadFileButton.addEventListener('click', function() {
    fileInput.click();
  });

  // Отправка формы при выборе изображений
  imageInput.addEventListener('change', function() {
    messageForm.submit();
  });

  // Отправка формы при выборе видео
  videoInput.addEventListener('change', function() {
    messageForm.submit();
  });

  // Отправка формы при выборе других файлов
  fileInput.addEventListener('change', function() {
    messageForm.submit();
  });

  // Отправка формы при нажатии на кнопку "Send"
  sendButton.addEventListener('click', function() {
    messageForm.submit();
  });

  // Отправка формы при нажатии Enter в поле ввода
  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { // Предотвращаем перенос строки и отправляем форму
      e.preventDefault();
      messageForm.submit();
    }
  });

  // Обработка получения сообщений через WebSocket
  const groupId = "{{ group.id }}";
  const chatSocket = new WebSocket(
      `ws://${window.location.host}/ws/chat/${groupId}/`
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const message = data['message'];
    const user = data['user'];
    const created = data['created'];
    const image = data['image']; // Обработка изображения
    const video = data['video']; // Обработка видео
    const file = data['file']; // Обработка файла

    let messageHTML = `
      <div class="message">
        <small class="message-meta">${user} ${new Date(created).toLocaleTimeString()}</small>
        <p class="message-body">${message}</p>
        <hr />
    `;

    if (image) {
      messageHTML += `<img src="${image}" alt="Image" style="max-width: 100%; height: auto;"/>`;
    }

    if (video) {
      messageHTML += `<video controls style="max-width: 100%; height: auto;"><source src="${video}" type="video/mp4">Your browser does not support the video tag.</video>`;
    }

    if (file) {
      messageHTML += `<a href="${file}" download>Download file</a>`;
    }

    messageHTML += '</div>';

    document.querySelector('#chat_room').insertAdjacentHTML('beforeend', messageHTML);
    scrollToBottom();
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  function scrollToBottom() {
    const container = document.getElementById("chat_room");
    if (container) {
      container.scrollTop = container.scrollHeight - container.clientHeight;
    }
  }

  scrollToBottom();
});
</script>
{% endblock %}

{% endblock %}
